<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Plus Lucky Draw</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: linear-gradient(135deg, #141e30, #243b55);
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 40px;
  }

  h1 {
    margin-bottom: 10px;
  }

  .box {
    margin: 50px auto;
    width: 560px;
    height: 130px;
    background: #ffffff;
    color: #222;
    border-radius: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 38px;
    font-weight: bold;
    box-shadow: 0 20px 45px rgba(0,0,0,0.4);
    letter-spacing: 1px;
  }

  .blink {
    animation: blink 0.9s infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.45; }
  }

  button {
    padding: 14px 32px;
    font-size: 18px;
    border-radius: 30px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #ff9800, #ff5722);
    color: #fff;
    box-shadow: 0 6px 16px rgba(0,0,0,.35);
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  #info {
    margin-top: 14px;
    opacity: 0.85;
  }

  /* Modal + Fireworks styles */
  #fireworksCanvas {
    position: fixed;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 1000;
  }

  #congratsModal {
    position: fixed;
    left: 50%;
    top: 40%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.98);
    color: #111;
    padding: 26px 28px;
    border-radius: 14px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.45);
    z-index: 1001;
    min-width: 320px;
    display: none;
    text-align: center;
  }

  #congratsModal h3 { margin: 6px 0 14px 0; }
  #congratsModal button { margin-top: 8px; }
  .header-img { max-width: 920px; margin: 8px auto 22px; display:flex; justify-content:center; }
  .header-img img { max-width:100%; height:auto; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.45); background:#fff; padding:10px; }
</style>
</head>

<body>

<div class="header-img">
  <img src="assets/anniversary.png" alt="PLUS 10th Anniversary">
</div>

<h1>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏â‡∏•‡∏≠‡∏á 10 ‡∏õ‡∏µ PLUS!</h1>
<h2>‡∏•‡∏∏‡πâ‡∏ô‡∏£‡∏±‡∏ö iPhone 17 pro (256Gb) ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏≠‡∏µ‡∏Å‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏¢ ‡∏£‡∏ß‡∏°‡∏Å‡∏ß‡πà‡∏≤ 150,000 ‡∏ö‡∏≤‡∏ó</h2>

<input type="file" id="excelFile" accept=".xlsx,.xls">

<div class="box blink" id="nameBox">READY</div>

<button id="btn" onclick="startDraw()">START</button>

<div id="info"></div>

<canvas id="fireworksCanvas"></canvas>

<div id="congratsModal">
  <h3>‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏Å‡∏±‡∏ö!</h3>
  <div id="congratsName" style="font-size:20px;font-weight:700;margin-bottom:8px"></div>
  <button id="closeCongrats">‡∏õ‡∏¥‡∏î</button>
</div>

<script>
let names = [];
let running = false;
let currentIndex = -1;

/* =========================
   Load Excel
========================= */
document.getElementById("excelFile").addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = evt => {
    const wb = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
    const sheet = wb.Sheets["Name"];
    if (!sheet) return alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Sheet 'Name'");

    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    names = rows.map(r => r[0]).filter(v => v && v.toString().trim() !== "");

    document.getElementById("info").innerText =
      `üìä ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${names.length.toLocaleString()} ‡∏Ñ‡∏ô`;
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

/* =========================
   Lucky Draw (5 sec + slow down)
========================= */
function startDraw() {
  if (names.length === 0 || running) return;

  running = true;
  document.getElementById("btn").disabled = true;

  const box = document.getElementById("nameBox");
  box.classList.add("blink");

  const totalDuration = 5000;     // 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  const startTime = performance.now();
  let delay = 40;                 // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡πá‡∏ß
  const maxDelay = 300;           // ‡∏ä‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

  function roll() {
    const elapsed = performance.now() - startTime;
    const progress = Math.min(elapsed / totalDuration, 1);

    // ease-out (‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏à‡∏ö ‡∏¢‡∏¥‡πà‡∏á‡∏ä‡πâ‡∏≤)
    delay = 40 + (maxDelay - 40) * Math.pow(progress, 2);

    currentIndex = Math.floor(Math.random() * names.length);
    box.innerText = names[currentIndex];

    if (elapsed < totalDuration) {
      setTimeout(roll, delay);
    } else {
      finishDraw();
    }
  }

  roll();
}

/* =========================
   Finish & remove name
========================= */
function finishDraw() {
  running = false;

  const box = document.getElementById("nameBox");
  box.classList.remove("blink");

  // ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å
  const winner = names.splice(currentIndex, 1)[0];

  box.innerText = winner;

  document.getElementById("info").innerText =
    `üéØ ‡∏ú‡∏π‡πâ‡πÇ‡∏ä‡∏Ñ‡∏î‡∏µ | ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${names.length.toLocaleString()} ‡∏Ñ‡∏ô`;

  document.getElementById("btn").disabled = false;
  // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏•‡∏∏‡∏Ç‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
  try { showCongrats(winner); } catch(e) { console.warn(e); }
}

/* =========================
   Congrats modal + Fireworks
   - showCongrats(winner) will display modal and run fireworks ~8s
========================= */
function showCongrats(winner) {
  const modal = document.getElementById('congratsModal');
  const nameEl = document.getElementById('congratsName');
  const canvas = document.getElementById('fireworksCanvas');

  nameEl.innerText = `"${winner}"`;
  modal.style.display = 'block';
  canvas.style.display = 'block';

  startFireworks(8000);

  const closeBtn = document.getElementById('closeCongrats');
  const hideAll = () => { modal.style.display = 'none'; }
  closeBtn.onclick = () => { hideAll(); stopFireworks(); };
}

// Simple fireworks engine
let _fw = { running: false, particles: [], bursts: [], raf: null, spawnInt: null };
function startFireworks(duration = 8000) {
  const canvas = document.getElementById('fireworksCanvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;

  function resize() {
    canvas.width = window.innerWidth * dpr;
    canvas.height = window.innerHeight * dpr;
    canvas.style.width = window.innerWidth + 'px';
    canvas.style.height = window.innerHeight + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resize();
  window.addEventListener('resize', resize);

  _fw.running = true;
  _fw.particles = [];

  function rand(a,b){return a + Math.random()*(b-a)}

  function spawnBurst(x, y) {
    const count = Math.floor(rand(20, 40));
    const hue = Math.floor(rand(0, 360));
    for (let i=0;i<count;i++){
      const speed = rand(1.5, 6);
      const angle = rand(0, Math.PI*2);
      _fw.particles.push({
        x, y,
        vx: Math.cos(angle)*speed * (Math.random()*1.1+0.2),
        vy: Math.sin(angle)*speed * (Math.random()*1.1+0.2),
        life: rand(800,1600),
        age: 0,
        hue,
        size: rand(1.6,3.8)
      });
    }
  }

  function step(ts) {
    if (!_fw.running) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const now = performance.now();
    for (let p of _fw.particles){
      p.age += 16;
      p.vy += 0.06; // gravity
      p.vx *= 0.998;
      p.vy *= 0.998;
      p.x += p.vx;
      p.y += p.vy;

      const t = p.age / p.life;
      const alpha = Math.max(0, 1 - t);

      ctx.beginPath();
      ctx.fillStyle = `hsla(${p.hue}, 90%, 60%, ${alpha})`;
      ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
      ctx.fill();
    }

    // remove dead
    _fw.particles = _fw.particles.filter(p => p.age < p.life);

    _fw.raf = requestAnimationFrame(step);
  }

  // initial burst center top/mid, then random bursts
  spawnBurst(window.innerWidth*0.5, window.innerHeight*0.35);
  _fw.spawnInt = setInterval(() => {
    const x = rand(window.innerWidth*0.15, window.innerWidth*0.85);
    const y = rand(window.innerHeight*0.12, window.innerHeight*0.45);
    spawnBurst(x,y);
  }, 350);

  _fw.raf = requestAnimationFrame(step);

  // stop after duration
  setTimeout(() => { stopFireworks(); }, duration);
}

function stopFireworks(){
  const canvas = document.getElementById('fireworksCanvas');
  if (!_fw.running) return;
  _fw.running = false;
  if (_fw.spawnInt) clearInterval(_fw.spawnInt);
  if (_fw.raf) cancelAnimationFrame(_fw.raf);
  _fw.particles = [];
  // clear canvas and hide
  const ctx = canvas.getContext('2d');
  ctx && ctx.clearRect(0,0,canvas.width,canvas.height);
  canvas.style.display = 'none';
}
</script>

</body>
</html>
